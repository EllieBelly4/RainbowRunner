package main

import "text/template"

var templateFuncMap = template.FuncMap{
	"add":                        Add,
	"isNumberType":               IsNumberType,
	"isStringType":               IsStringType,
	"generateCallString":         GenerateCallString,
	"generateCallMemberFunction": GenerateCallMemberFunction,
}

const (
	// language=gotemplate
	templateString string = `package objects

/**
 * This file is generated by scripts/generatelua/generatelua.go
 * DO NOT EDIT
 */

import (
	lua2 "github.com/yuin/gopher-lua"
	lua "RainbowRunner/internal/lua"
)

const {{ .StructTypeNameVar }} = "{{ .Struct.Name }}"

func registerLua{{ .Struct.Name }}(state *lua2.LState) {
	mt := state.NewTypeMetatable({{ .StructTypeNameVar }})
	state.SetGlobal("{{ .Struct.Name }}", mt)
	state.SetField(mt, "new", state.NewFunction(newLua{{ .Struct.Name }}))
	state.SetField(mt, "__index", state.SetFuncs(state.NewTable(),
		luaMethods{{ .Struct.Name }}(),
	))
}

func luaMethods{{ .Struct.Name }}() map[string]lua2.LGFunction {
	return luaMethodsExtend(map[string]lua2.LGFunction{
{{- if .Struct.Fields }}
	{{- $struct := .Struct }}
	{{- range $i, $field := .Struct.Fields }}
		{{- if not $field.IsExported }}
		{{- continue }}
		{{- end }}

		{{- if isStringType $field }}
		"{{ $field.Name }}": luaGenericGetSetString[{{ $struct.FullTypeString }}](func(v $struct.FullTypeString) *string { return &v.{{ $field.Name }} }),
		{{- else if isNumberType $field }}
		"{{ $field.Name }}": luaGenericGetSetNumber[{{ $struct.FullTypeString }}, {{ $field.FullTypeString }}](func(v {{ $struct.FullTypeString }}) *{{ $field.FullTypeString }} { return &v.{{ $field.Name }} }),
		{{- end }}
	{{- end }}
{{- end -}}

{{- $struct := .Struct }}
{{- range $i, $method := .Struct.Methods }}
		{{- if not $method.IsExported }}
		{{- continue }}
		{{- end }}
		"{{ $method.Name }}": {{ generateCallMemberFunction $struct $method }},
{{- end }}
	}, luaMethodsDRObject)
}

func newLua{{ .Struct.Name }}(l *lua2.LState) int {
{{- if .Struct.Constructor }}
    obj := {{ generateCallString .Struct.Constructor }}
{{- end }}
	ud := l.NewUserData()
	ud.Value = obj

	l.SetMetatable(ud, l.GetTypeMetatable({{ .StructTypeNameVar }}))
	l.Push(ud)
	return 1
}
`
)
